<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserve Now</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">  
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename = 'CSS/reserve_student_styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <p id="text-logo">Allocate</p>
            <ul id="header-tabs">
                <li id="home-tab" class="other-tabs"><a href="/Homepage/{{id}}">Home</a></li>
                <li id="requests-button" class="other-tabs"><a href="/ViewRequests/{{id}}">My Requests</a></li>
                <li id="reservations-button" class="other-tabs"><a href="/ViewReservations/{{id}}">Reservations</a></li>
                <li id="reserve-button"><a href="/ReserveSchedule/{{id}}">Reserve Now</a></li>
            </ul>
        </header>
        <main>  
            <div class="wrapper">
                <div class="filters">
                    <select id="building">
                        <option value="IT">IT</option>
                        <option value="ENG">ENG</option>
                    </select>
                    <select id="room-type">
                        <option value="room">Lecture Room</option>
                        <option value="lab">Lab</option>
                        <option value="auditorium">Auditorium</option>
                        <option value="outdoor">Outdoor Space</option>
                    </select>
                    <input type="number" id="capacity" placeholder="Capacity">
                    <div class="date-selector">
                        <button id="prev-date">&lt;</button>
                        <input type="date" id="selected-date" />
                        <button id="next-date">&gt;</button>
                    </div>
                </div>
            
                <div class="schedule-container">
                    <div class="schedule" id="schedule"></div>
                </div>
            
                <!-- Modal -->
                <div id="modal" class="modal hidden">
                    <div class="modal-content">
                        <h3>Confirm Reservation</h3>
                        <form method="post" action="">
                        <!-- <p>Facility: </p> -->
                            <input type="text" id="modal-facility" value="modal-facility" name="facility" readonly/>
                        <!-- <p id="modal-facility"></p> -->
                            <label>Start Time: <input type="time" id="start-time" name="start"/></label>
                            <label>End Time: <input type="time" id="end-time" name="end"/></label>
                            <div class="modal-buttons">
                                <button id="confirm-btn">Confirm</button>
                                <button id="cancel-btn">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            
        </main>
    </div>
    <footer>
        <img id="psut-logo" src="{{ url_for('static', filename = 'images/psut_logo_white.png') }}">
        <ul class="footer-options">
            <li><a href="/AboutUsAcademic">About Us</a></li>
            <li><a href="/ContactUsAcademic">Contact</a></li>
        </ul>
    </footer> 

    <script>
        const today = new Date();
        let currentDate = new Date(today);
        const facilities = ['IT201', 'IT202', 'IT203', 'IT204', 'IT205', 'IT206', 'IT207', 'IT208'];
        const hours = Array.from({ length: 24 }, (_, i) => i); // 12 AM to 11 PM

        const reservationsByDate = {
            '2025-05-12': [
                { facility: 'IT201', start: 8, end: 10 },
                { facility: 'IT203', start: 11, end: 12 },
                { facility: 'IT207', start: 13, end: 15 },
                { facility: 'IT206', start: 13, end: 14 }
            ],
            '2025-05-13': [
                { facility: 'IT201', start: 9, end: 11 }
            ]
        };

        let isDragging = false;
        let dragStartCell = null;
        let dragEndCell = null;

        function generateSchedule() {
            const schedule = document.getElementById('schedule');
            schedule.innerHTML = '';

            const isToday = currentDate.toDateString() === today.toDateString();
            const dateKey = currentDate.toISOString().split('T')[0];
            const reservedSlots = reservationsByDate[dateKey] || [];

            // Header row
            const headerRow = document.createElement('div');
            headerRow.className = 'row';
            headerRow.appendChild(createCell('', true));
            hours.forEach(h => {
                const label = h === 0 ? '12 AM' :
                    h < 12 ? `${h} AM` :
                    h === 12 ? '12 PM' :
                    `${h - 12} PM`;
                headerRow.appendChild(createCell(label, true));
            });
            schedule.appendChild(headerRow);

            // Facility rows
            facilities.forEach(facility => {
                schedule.appendChild(createCell(facility, true));

                let hour = 0;
                while (hour < 24) {
                    const reservation = reservedSlots.find(r => r.facility === facility && r.start === hour);
                    const isPastHour = isToday && hour < today.getHours();
                    const isReservedMiddle = reservedSlots.some(r => r.facility === facility && hour > r.start && hour < r.end);

                    if (reservation) {
                        const span = reservation.end - reservation.start;
                        const cell = createCell(`${formatHour(hour)}\nReserved`, false, facility, hour);
                        cell.classList.add('reserved');
                        cell.style.gridColumn = `span ${span}`;
                        schedule.appendChild(cell);
                        hour += span;
                    } else if (isReservedMiddle) {
                        hour++; // skip middle of reserved span
                    } else if (isPastHour) {
                        let startHour = hour;
                        while (
                            hour < today.getHours() &&
                            !reservedSlots.some(r => r.facility === facility && hour >= r.start && hour < r.end)
                        ) {
                            hour++;
                        }
                        const span = hour - startHour;
                        const cell = createCell(`Was Available`, false);
                        cell.classList.add('was-available');
                        cell.style.gridColumn = `span ${span}`;
                        schedule.appendChild(cell);
                    } else {
                        const cell = createCell('', false, facility, hour);
                        schedule.appendChild(cell);
                        hour++;
                    }
                }
            });
        }

        function updateDateInput() {
            const input = document.getElementById('selected-date');
            input.valueAsDate = currentDate;
            input.min = today.toISOString().split('T')[0];
        }

        document.getElementById('prev-date').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 1);
            if (currentDate < today) currentDate = new Date(today);
            refreshSchedule();
        });

        document.getElementById('next-date').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 1);
            refreshSchedule();
        });

        document.getElementById('selected-date').addEventListener('change', (e) => {
            currentDate = new Date(e.target.value);
            refreshSchedule();
        });

        function createCell(content, isHeader = false, facility = null, hour = null) {
            const div = document.createElement('div');
            div.className = 'cell';
            if (isHeader) div.classList.add('header');
            div.textContent = content;

            if (!isHeader && !div.classList.contains('reserved') && !div.classList.contains('was-available')) {
                div.dataset.facility = facility;
                div.dataset.hour = hour;

                div.addEventListener('mousedown', () => {
                    isDragging = true;
                    dragStartCell = div;
                    clearSelection();
                    div.classList.add('selected');
                });

                div.addEventListener('mouseenter', () => {
                    if (isDragging && div.dataset.facility === dragStartCell.dataset.facility) {
                        clearSelection();
                        highlightRange(dragStartCell, div);
                    }
                });

                div.addEventListener('mouseup', () => {
                    if (!isDragging) return;
                    isDragging = false;
                    dragEndCell = div;
                    openDragModal(dragStartCell, dragEndCell);
                });
            }

            return div;
        }


        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        function highlightRange(start, end) {
            const facility = start.dataset.facility;
            const startHour = parseInt(start.dataset.hour);
            const endHour = parseInt(end.dataset.hour);

            const [minHour, maxHour] = [startHour, endHour].sort((a, b) => a - b);

            const allCells = document.querySelectorAll(`.cell[data-facility='${facility}']`);
            allCells.forEach(cell => {
                const h = parseInt(cell.dataset.hour);
                if (h >= minHour && h <= maxHour) {
                    cell.classList.add('selected');
                }
            });
        }

        function clearSelection() {
            document.querySelectorAll('.cell.selected').forEach(c => c.classList.remove('selected'));
        }

        function formatHour(hour) {
            return hour < 12 ? `${hour}:00 AM` : `${hour === 12 ? 12 : hour - 12}:00 PM`;
        }

        function openDragModal(startCell, endCell) {
            const facility = startCell.dataset.facility;
            const h1 = parseInt(startCell.dataset.hour);
            const h2 = parseInt(endCell.dataset.hour);
            const [startHour, endHour] = [h1, h2].sort((a, b) => a - b);

            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-facility').textContent = `Facility: ${facility}`;
            document.getElementById('modal-facility').value = `${facility}`;
            document.getElementById('start-time').value = `${String(startHour).padStart(2, '0')}:00`;
            document.getElementById('end-time').value = `${String(endHour + 1).padStart(2, '0')}:00`;

            document.getElementById('confirm-btn').onclick = () => {
                const start = parseInt(document.getElementById('start-time').value.split(':')[0]);
                const end = parseInt(document.getElementById('end-time').value.split(':')[0]);
                const dateKey = currentDate.toISOString().split('T')[0];
                const reservedSlots = reservationsByDate[dateKey] || [];

                const conflict = reservedSlots.some(r =>
                    r.facility === facility && !(end <= r.start || start >= r.end)
                );

                if (conflict) {
                    alert("Time slot conflict! Please select another time.");
                    document.getElementById('modal').classList.add('hidden');
                    return;
                }

                const params = new URLSearchParams({ facility, start, end, date: dateKey });
                // window.location.href = `/reserve-form?${params.toString()}`;
                fetch("/ReserveSchedule/{{id}}", {method: "POST"})
            };

            document.getElementById('cancel-btn').onclick = () => {
                document.getElementById('modal').classList.add('hidden');
            };
        }

        function refreshSchedule() {
            updateDateInput();
            generateSchedule();
        }

        refreshSchedule();
    </script>
</body>
</html> 
